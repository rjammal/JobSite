<div id="search"></div>

<script type="text/javascript" src="/Users/smkusalo/Documents/JavaScript/lib/jquery.js"></script>
<link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css">
<link rel="stylesheet" href="main.css">
<script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDA_7tzee1bTUITMK4aMnGwNpyDPCfXoL8"></script>

<div>

<div id="food-items">
<form>
<label>SF Food Trucks</label></br>
<div id="description" class="col-xs-3">Check the type of food to see its location on the map. Move the map to see more options.</div>
<br>
<br>
<div><input type="checkbox" id="check-all"><span id="select-deselect">Check All</span></div>
<div class="form-group"  id="food-truck-types">
</div>
</form>
</div>

<div id="map" class="col-xs-9 col-xs-offset-3"></div>

</div>

<script type="text/javascript">
$(function () {
    var mapOptions = {
        center: new google.maps.LatLng(37.7760, -122.4182),
        zoom: 16
    };

    var map = new google.maps.Map(document.getElementById("map"), mapOptions);

    google.maps.event.addListenerOnce(map, 'idle', function(){

    $.ajax("http://data.sfgov.org/resource/rqzj-sfat.json", {
        dataType: "json",
        url: "http://data.sfgov.org/resource/rqzj-sfat.json",
        success: function (data) {
            var foodTypes = {};
            for (var i = 0; i < data.length; i++) {
                var truck = data[i];
                if (truck.fooditems === undefined) {
                    continue;
                }
                var position = new google.maps.LatLng(truck.latitude, truck.longitude);
                var marker = new google.maps.Marker({
                    map: map,
                    position: position, 
                    visible: false
                });
                var infowindow = new google.maps.InfoWindow({
                    content: truck.applicant
                });

                google.maps.event.addListener(marker, 'click', (function (iwindow, mark) {
                    return function () {
                        iwindow.open(map, mark);
                    }
                })(infowindow, marker));

                // use hash to find markers
                if (foodTypes[truck.fooditems]) {
                    foodTypes[truck.fooditems].push(marker);
                } else {
                    foodTypes[truck.fooditems] = [marker];
                }
            }

            // use array to sort
            var foodArray = [];
            for (var food in foodTypes) {
                foodArray.push(food);
            }
            foodArray.sort();

            $foodTypes = $("#food-truck-types");
            foodArray.forEach( function (food, i) {
                var $div = $('<div>').html(
                    '<input type="checkbox" name="food-type" value="' + i + '">' + 
                    '<span>' + food + '</span>');
                $foodTypes.append($div);
                $div.addClass("food");
                if (foodTypes[food].some( function (mark) {
                    return map.getBounds().contains(mark.getPosition());
                })) {
                    $div.addClass("show-description")
                } else {
                    $div.addClass("hide-description");
                }
            });

            google.maps.event.addListener(map, "bounds_changed", function () {
                $foodTypes.children().each( function (i, el) {
                    $div = $(el);
                    if (foodTypes[foodArray[i]].some( function (mark) {
                        return map.getBounds().contains(mark.getPosition());
                    })) {
                        $div.addClass("show-description");
                        $div.removeClass("hide-description");
                    } else {
                        $div.removeClass("show-description");
                        $div.addClass("hide-description");
                    }
                });
            });

            $(".food input").change( function (event) {
                var $food = $(event.currentTarget);
                var index = $food.attr("value");
                var markerLookup = foodArray[index];
                foodTypes[markerLookup].forEach( function (mark) {
                    mark.setVisible($food.prop("checked"));
                });
            });
        }
    });
    });

    $('#check-all').click(function (event) {
        if ($(event.currentTarget).prop('checked')) {
            $(".food input").prop("checked", true).trigger("change");
            $("#select-deselect").text("Uncheck All");
        } else {
            $(".food input").prop("checked", false).trigger("change");
            $("#select-deselect").text("Check All");
        }
    });
    
});
</script>